#!/bin/sh

# This script runs on the startup of every POSIX compliant shell.

# set the umask
umask 022

# Exec out to tmux if possible
if [ -z "${SSH_CLIENT}" ] && [ -z "${VIMRUNTIME}" ] && [ -z "${TMUX}" ]; then
    # Only launch TMUX if we're not in an SSH session
    # and we're not in a VIM session
    # and we're not already in a TMUX session
    if command -v tmux >/dev/null 2>&1; then
        if tmux has-session 2>/dev/null; then
            exec tmux attach
        else
            exec tmux new-session
        fi
    fi
fi

# Colours for various things
blue="\033[38;5;4m"
green="\033[38;5;85m"
red="\033[38;5;1m"
cyan="\033[38;5;6m"
underline_cyan="\033[4;38;5;6m"
reset="\033[m"
bold="\033[1m"

# A prompt for git
# Technically not strictly POSIX because "local", but `dash` supports it
prompt_git() {
    [ "${GIT_PROMPT}" = "1" ] || return
    local branch stats total num_added num_removed tmp
    branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null) || return
    case $branch in HEAD) branch=$(git rev-parse --short HEAD);; esac

    stats=$(git diff-files --shortstat 2>/dev/null)
    total="${stats%% file*}"; total="${total## }"
    tmp="${stats% ins*}"; [ "$tmp" != "$stats" ] && num_added="${tmp##* }" || num_added=0
    tmp="${stats% del*}"; [ "$tmp" != "$stats" ] && num_removed="${tmp##* }" || num_removed=0

    local totals=""
    if [ -n "${total}" ]; then
        totals="${bold}:${blue}${total}"
        [ "${num_added}" -gt 0 ] 2>/dev/null && totals="${totals}${green}+${num_added}"
        [ "${num_removed}" -gt 0 ] 2>/dev/null && totals="${totals}${red}-${num_removed}"
    fi
    printf "${bold}[${red}${branch}${reset}${totals}${reset}${bold}] ${reset}"
}

PS1='$(printf "\033[1;38;5;85m${USER}${SSH_CLIENT:+${red}@${underline_cyan}$(uname -n)}${reset}${bold}:\033[38;5;75m${PWD#${HOME}/}${reset}${bold}#${reset}") $(prompt_git)'

# Set ls alias with color support
if command -v eza >/dev/null 2>&1; then
    alias ls="eza --color=auto"
else
    # Fallback: check for GNU or busybox ls
    case "$(ls --version 2>&1)" in
        *GNU*|*BusyBox*) alias ls="ls --color=auto" ;;
    esac
fi

if [ -n "${GOOGLE_CLOUD_PROJECT}" ]; then
    alias glogin="gcloud auth application-default login && gcloud auth application-default set-quota-project ${GOOGLE_CLOUD_PROJECT}"
fi

# A function to switch to a specific directory/tmux session
mux() {
    [ -z "${1}" ] && return
    command -v tmux >/dev/null || return

    # If session already exists, just switch to it (skip directory search)
    if tmux has-session -t "${1}" 2>/dev/null; then
        tmux switch-client -t "${1}"
        return
    fi

    # Search for directory to create new session
    . "${HOME}/.config/user-dirs.dirs"
    local dir min max use_fd depth_awk
    depth_awk='NR==1{n=NF;m=$0} NF<n{m=$0;n=NF} END{print m}'

    use_fd=false
    command -v fd >/dev/null && use_fd=true

    # Bucketed search: 1-2, 3-4, 5+ (optimized for shallow-biased access patterns)
    for bucket in 1:2 3:4 5:; do
        min="${bucket%%:*}"
        max="${bucket##*:}"

        # NOTE: We can't quote the `max` expansions here in case they don't exist. Otherwise, we may end up with a stray argument for both commands.
        if $use_fd; then
            dir=$(fd -L -t d -i -g "${1}" "${XDG_DOCUMENTS_DIR}" --min-depth "$min" ${max:+--max-depth=$max} | awk -F'/' "$depth_awk")
        else
            dir=$(find -L "${XDG_DOCUMENTS_DIR}" -mindepth "$min" ${max:+-maxdepth} ${max} -type d -iname "${1}" | awk -F'/' "$depth_awk")
        fi

        [ -n "${dir}" ] && break
    done

    [ -z "${dir}" ] && return
    tmux new-session -ds "${1}" -c "${dir}" \; switch-client -t "${1}"
}

alias tls="tmux list-sessions"

stty -ixon
export GIT_PROMPT=1
